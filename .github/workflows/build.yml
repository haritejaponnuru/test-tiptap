name: CICD Workflow
on:
  push:
    branches:
      - main
      - 'releases/**'
    tags:
      - v*             # Push events to v1 tag
      - v**           # Push events to v1.0, v1.1, and v1.9 tags
  pull_request:
    branches:
      - 'releases/**'
  # Also trigger on page_build, as well as release created events
  page_build:
  release:
    types: # This configuration does not affect the page_build event above
      - created

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      # Runs a single command using the runners shell
      - name: Run a one-line script
        run: echo Hello, world!

      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.
      - name: Build and analyze
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
     # - name: version
     #   run: echo "::set-output name=version::$(./bin/azblogfilter --version)"
     #   id: version
     # - name: release
     #  uses: actions/create-release@v1
     #   id: create_release
     #   with:
     #   draft: false
     #    prerelease: false
     #    release_name: ${{ steps.version.outputs.version }}
     #    tag_name: ${{ github.ref }}
     #     body_path: CHANGELOG.md
     #   env:
     #    GITHUB_TOKEN: ${{ github.token }}
          
      - name: Get the version
        id: get_version
        run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
        
      - name: Push to Docker Hub
        uses: docker/build-push-action@v1 # Info: https://github.com/docker/build-push-action/tree/releases/v1#tags
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          repository: ${{ steps.login-ecr.outputs.registry }}
          tag_with_ref: true # Info: https://github.com/docker/build-push-action/tree/releases/v1#tag_with_ref
          tag_with_sha: true # Info: https://github.com/docker/build-push-action/tree/releases/v1#tag_with_sha
          tags: latest
